{% load static %}

<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>P4 Drawing</title>

  <link rel="stylesheet" type="text/css" href="{% static 'draw/vendor/bootstrap/css/bootstrap.min.css' %}">
  <script type="text/javascript" src="{% static 'draw/vendor/jquery/jquery-3.3.1.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'draw/vendor/paper/paper-full.min.js' %}"></script>

  <style type="text/css">
    canvas {
      border: 2px solid skyblue;
/*       width: 1063px; */
      width: 850px;
/*       height: 2048px; */
      height: 1638px;
      display: block;
      margin: 10% auto 0 auto;
      background-image: url("{%static 'draw/images/img2.jpg'%}");
    }
    
    #myCanvas { 
        z-index: 5;
    }
    
    .sticky-nav {
        background-image: linear-gradient(to bottom left, rgba(0, 0, 0, 1), rgba(0, 0, 0, .8));
        width: 100%;
        height: 10%;
        top: 0;
        text-decoration: none;
        list-style: none;
        text-transform: uppercase;
        display: inline-block;
        z-index: 999;
        position: fixed; 
      }
      
      .sticky-nav li {
        color: white;
      }
    
    .sticky-note {
      position: absolute;
      top: 50%;
        left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      padding: 20px 30px 20px 30px;
      background-color: skyblue;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, .4);
    }
    
    .sticky-note-header {
      background-color: skyblue;
      cursor: move;
      padding: 0 20px;
      margin-bottom: 20px;
      padding-left: 5px;
      font-weight: 600;
      font-size: 22px;
    }
    
    .note-send {
      color: black;
      font-size: 40px;
      position: absolute;
      bottom: 35px;
      right: 40px;
    }
    
    .note-send:hover {
      color: red; /* TODO: change color to sticky note color? */
      font-size: 50px;
    }
    
    textarea {
      height: 200px;
      width: 300px;
      padding: 20px;
      font-size: 20px;
    }
    
    textarea:focus {
      outline: none;
    }
    
  </style>

</head>

<body>
  <!-- You may change the dimensions of this canvas -->
  <canvas id="myCanvas"></canvas>
  <div class="sticky-nav">
    <li>edit</li>
    <li>edit2</li>
  </div>
  
  <div class="sticky-note" id="sticky-note">
    <div id="sticky-note-header" class="sticky-note-header">Sticky Note</div>
    <ion-icon class="note-send" name="send" onclick="alert($('textarea').val())"></ion-icon> <!-- Send textarea val to websocket -->
    <textarea id="textarea" name="note" placeholder="Note"></textarea>
  </div>
  <script src="https://unpkg.com/ionicons@4.5.10-0/dist/ionicons.js"></script>
</body>
  
<script>
  // setting up the canvas and one paper tool
  var canvas = document.getElementById('myCanvas');
  paper.setup(canvas);
  var tool = new paper.Tool();

  // getting the URL (you may want to use for Exercise 3)
  var url = window.location.href;
  if (url.indexOf("?size=small") < 0) {
    
  }

  path = new paper.Path();
  path.strokeWidth = 4;
  var strokeColor = randomColor();
  path.strokeColor = strokeColor;
  idMap = {};
  var id = randomNumber();
  
  
  tool.onMouseDown = function(event) {
    id = randomNumber();
    idMap[id] = new paper.Path();
    idMap[id].add(event.point);
    var obj = {
      x: event.point.x,
      y: event.point.y,
      id: id,
      newPath: true
    }
    socket.send(JSON.stringify(obj));
  }
  
  tool.onMouseDrag = function(event) {
    var obj = {
      color: strokeColor,
      x: event.point.x,
      y: event.point.y,
      id: id,
      newPath: false
    };
    socket.send(JSON.stringify(obj)); // send message to server
    path.strokeColor = strokeColor;
    path.add(event.point);
  }


  // create new websocket connecting to server 
  var socket = new WebSocket(
    'wss://p3-websockets-jwu7082-jwu7082387298.codeanyapp.com/ws/draw');
  // receive message from server
  socket.onmessage = function(receivedMessage) {
    var currId = id; 
        var obj = JSON.parse(receivedMessage.data);
        var x = obj.x,
            y = obj.y,
            color = obj.color,
            id = obj.id.toString(),
            newPath = obj.newPath;
        if (!(id in idMap) || (newPath)) {
          idMap[id] = new paper.Path();
        }
        idMap[id].add(new paper.Point(x, y)); 
        idMap[id].strokeColor = color;
        idMap[id].strokeWidth = 4;
    
    path = idMap[currId];
    
  };

  // notify console if socket closes unexpectedly
  socket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };
  
  // https://stackoverflow.com/questions/1484506/random-color-generator
  function randomColor() {
    return '#'+Math.random().toString(16).substr(-6);
  }
  // http://www.javascriptkit.com/javatutors/randomnum.shtml
  function randomNumber() {
    return Math.floor(Math.random()*11);
  }
  
  
  
  // DRAG
  // https://www.w3schools.com/howto/howto_js_draggable.asp
  // Make the DIV element draggable:
  dragElement(document.getElementById("sticky-note"));

  function dragElement(elmnt) {
    var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    if (document.getElementById(elmnt.id + "-header")) {
      // if present, the header is where you move the DIV from:
      document.getElementById(elmnt.id + "-header").onmousedown = dragMouseDown;
    } else {
      // otherwise, move the DIV from anywhere inside the DIV: 
      elmnt.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
      e = e || window.event;
      e.preventDefault();
      // get the mouse cursor position at startup:
      pos3 = e.clientX;
      pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      // call a function whenever the cursor moves:
      document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
      e = e || window.event;
      e.preventDefault();
      // calculate the new cursor position:
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      // set the element's new position:
      elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
      elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
      // stop moving when mouse button is released:
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }
</script>

</html>